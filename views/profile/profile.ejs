<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= profile.username %> - Profile
  </title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/main.css">
</head>

<body class="bg-light">
  <%- include('../partials/navbar') %>

    <div class="container my-5" style="max-width: 700px;">
      <%- include('../partials/alert') %>
        <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
          <div class="card-header bg-primary text-white py-3">
            <h3 class="mb-0"><i class="bi bi-person-circle me-2"></i>Profile</h3>
          </div>

          <div class="card-body bg-light">
            <div class="d-flex align-items-center mb-4">
              <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="User Avatar" width="90"
                height="90" class="rounded-circle border me-3" />
              <div>
                <h4 class="fw-bold mb-1">
                  <%= profile.username %>
                </h4>
                <span class="badge bg-secondary text-capitalize">
                  <%= profile.role %>
                </span>
              </div>
            </div>

            <hr class="mb-4">

            <div class="row mb-3">
              <div class="col-md-6">
                <p class="text-muted mb-1">Email</p>
                <p class="fw-semibold">
                  <%= profile.email %>
                </p>
              </div>
              <div class="col-md-6">
                <p class="text-muted mb-1">Average Rating</p>
                <div class="d-flex align-items-center">
                  <span class="fs-5 text-warning me-2">★</span>
                  <span class="fs-5">
                    <%= reviews.avgRating.toFixed(1) %>
                  </span>
                </div>
              </div>

              <div class="mb-3">
                <p class="text-muted mb-1">Total Reviews</p>
                <p class="fw-semibold">
                  <%= reviews.reviewCount || 0 %>
                </p>
              </div>


              <div class="mb-3">
                <p class="text-muted mb-1">Reviews</p>

                <% if (reviews.userDetails && reviews.userDetails.length> 0) { %>
                  <% reviews.userDetails.forEach(review=> { %>
                    <div class="border rounded p-3 bg-white mb-3">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>
                          <%= review.reviewer.username %>
                        </strong>
                        <span class="text-warning">
                          <% for (let i=0; i < review.rating; i++) { %>★<% } %>
                        </span>
                      </div>
                      <p class="mb-1">
                        <%= review.comment %>
                      </p>
                      <small class="text-muted">
                        <%= new Date(review.createdAt).toLocaleDateString() %>
                      </small>
                    </div>
                    <% }) %>
                      <% } else { %>
                        <div class="border rounded p-3 bg-white">No reviews yet.</div>
                        <% } %>
              </div>


              <% if (isLoggedIn && userId.toString() !==profile._id.toString()) { %>
                <!-- Show Leave Review button -->
                <div class="d-flex justify-content-center gap-3 mt-4">
                  <button type="button" class="btn btn-primary px-4" data-bs-toggle="modal"
                    data-bs-target="#reviewModal">
                    <i class="bi bi-star-fill me-1"></i> Leave a Review
                  </button>
                </div>
                <% } else if (!isLoggedIn) { %>
                  <!-- Guest users -->
                  <div class="d-flex justify-content-center gap-3 mt-4">
                    <a href="/auth/login" class="btn btn-outline-primary px-4">
                      <i class="bi bi-box-arrow-in-right me-1"></i> Login to Leave a Review
                    </a>
                  </div>
                  <% } %>
                  
            </div>
          </div>
        </div>
    </div>
</body>
<%- include('reviewProfile', { profile}) %>
  <%- include('../partials/footer') %>